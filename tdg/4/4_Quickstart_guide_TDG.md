Пример №4 - Изменение модели данных

# Подготовка к работе

Выполните установку TDG в соответствии с инструкцией по адресу https://www.tarantool.io/ru/tdg/1.5/deployment/.

Проверьте работоспособность TDG, открыв web-интерфейс по адресу
<http://ip-адрес:порт> (при развёртывании кластера с примером конфигурации из папки
`deploy` это, например http://172.19.0.2:8080, а для локально развернутого TDG это
http://localhost:8080), где

    * ip-адрес - это адрес сервера, где установлен любой экземпляр TDG,
    * порт - это http-порт любого из экземпляров TDG на этом сервере.

При входе в web-интерфейс свеже-установленного TDG авторизация не требуется, поэтому
вы увидите главное окно с навигационным меню слева.

По-умолчанию открывается вкладка **Cluster**, где можно выполнить настройку
кластера (назначить роли и настроить репликацию если они не были заданы в файле
конфигурации кластера при установке) для экземпляров кластера TDG. Подробнее -
в документации https://www.tarantool.io/ru/tdg/1.5/cluster_setup/#replicasets-roles-setup.

После выполнения первоначальной конфигурации кластера нажмите кнопку **Bootstrap vshard**
для инициализации распределённого хранилища данных.

## Подготовка установленного TDG к работе

Для завершения процесса запуска TDG в работу необходимо:
-- Задать доменную модель.
-- Загрузить конфигурацию и исполняемый код для обработки данных.

Все необходимые данные указываются в конфигурационном файле, включая ссылки на другие
файлы. Затем все необходимые файлы (конфигурационный файл и все упоминаемые в нём
файлы) запаковываются в ZIP архив и загружаются на странице **Configuration files**.
Далее приведено подробное описание данного процесса с указанием данных, используемых в примере.

### Доменная модель

Создайте файл `model.avsc` со следующим содержимым:

```json
[
    {
        "name": "Person",
        "type": "record",
        "logicalType": "Aggregate",
        "doc": "person",
        "fields": [
            {"name": "id", "type": "long"},
            {"name": "name", "type": "string"},
            {"name": "lastActivityDate", "type": ["null", "string"]}
        ],
        "indexes": ["id", "name", "lastActivityDate"]
    }
]
```
Подробнее о разработке доменной модели изложено в документации https://www.tarantool.io/ru/tdg/1.5/domain_model/.

### Конфигурация

Создайте конфигурационный файл `config.yml`, в котором заданы основные параметры
обработки данных: модель, функции, пайплайны, коннектор, входной и выходной процессоры.

```yml
types:
  __file: model.avsc

functions:
  router: {__file: router.lua}
  classifier: {__file: classificator.lua}


pipelines:
  router:
    - router
  classifier:
    - classifier

connector:
  input:
    - name: http
      type: http
      pipeline: router

  routing:
    - key: input_key
      output: to_input_processor

  output:
    - name: to_input_processor
      type: input_processor

input_processor:
  classifiers:
    - name: classifier
      pipeline: classifier

  storage:
    - key: add_person
      type: Person
```

### Исполняемый код

#### Роутер

Создайте файл `router.lua` со следующим содержимым:

```lua
#!/usr/bin/env tarantool

local param = ...

local ret = {obj = param, priority = 1, routing_key = 'input_key'}

return ret
```

Он выставляет всем входящим запросам `routing_key = 'input_key'`, адресующий
к входному процессору 'input_processor' (секция `connector / routing` в `config.yml`)

#### Классификатор

Создайте файл `classificator.lua` со следующим содержимым:

```lua
#!/usr/bin/env tarantool

local param = ...

if param.obj.id ~= nil then
  param.routing_key = "add_person"
  return param
end

param.routing_key = "unknown_type"
return param
```

Он выставляет ключ `routing_key = 'add_person'` при наличии у записи поля  `id` и
`routing_key = "unknown_type"` во всех остальных случаях.

Подробнее про обработку запросов, не прошедших классификацию можно прочитать в
документации - https://www.tarantool.io/ru/tdg/1.5/repair_queue/.

### Загрузка конфигурации

Получившиеся файлы `model.avsc`, `config.yml`, `router.lua` и `classificator.lua`
необходимо запаковать в архив формата ZIP.

Полученный архив необходимо перетащить мышкой в секцию **Upload configuration** на
вкладке **Configuration files**. После нажатия кнопки **Save** конфигурация должна
загрузиться в систему и начать отображаться на вкладке **Model**.

### Настройка доступа

Для полноценной работы с TDG вам понадобится создать пользователя и включить
авторизацию. Для выполнения запросов на чтение и запись данных, необходимо настроить
доступ к используемым агрегатам для используемого пользователя. Подробнее про выполнение
настроек безопасности указано в документации - https://www.tarantool.io/ru/tdg/1.5/security/.

Теперь TDG готов выполнять запросы и обрабатывать информацию.

# Изменение модели данных

Далее мы выполним загрузку нескольких объектов со старой моделью данных, затем обновим
конфигурацию, внеся изменения в модель данных и загрузим новые данные.
В итоге будет продемонстрирован вывод как старых, так и новых данных с обновленной
моделью данных.

## Загрузка тестовых данных со старым набором полей

Перед загрузкой новой конфигурации добавим несколько объектов со старой конфигурацией
для сравнения. Для этого на вкладке **Test** выполните следующие два запроса.

Первый:
```json
{
 "id": 1,
 "name": "John Smith",
 "lastActivityDate": "2020-01-11"
}
```

Второй:
```json
{
 "id": 2,
 "name": "Adam Sanders",
 "lastActivityDate": "2020-01-12"
}
```

## Изменение конфигурации

### Изменение модели данных

Для изменения модели данных необходимо отредактировать файл `model.avsc`.
Добавьте к сущности 'Person' новые поля `sex` и `birthday`.
В результате содержимое файла `model.avsc` должно выглядеть следующим образом:

```json
[
    {
        "name": "Person",
        "type": "record",
        "logicalType": "Aggregate",
        "doc": "person",
        "fields": [
            {"name": "id", "type": "long"},
            {"name": "name", "type": ["null", "string"]},
            {"name": "sex", "type": ["null", "string"]},
            {"name": "birthday", "type": ["null", "string"]},
            {"name": "lastActivityDate", "type": ["null", "string"]}
        ],
        "indexes": ["id", "name", "lastActivityDate"]
    }
]
```

### Загрузка новой конфигурации

Для изменения модели данных сформируйте полный комплект файлов
конфигурации (не забудьте включить в него новую версию файла `model.avsc`),
упакуйте его в ZIP архив и загрузите новую конфигурацию на вкладке **Configuration files**.

### Загрузка тестовых данных с новым набором полей

Загрузите еще один тестовый объект, но на этот раз с дополнительными полями `sex` и `birthday`,
выполнив следующую команду на вкладке **Test**:
```json
{
 "id": 3,
 "name": "Isaac Black",
 "sex": "male",
 "birthday": "1998-05-09",
 "lastActivityDate": "2020-01-14"
}
```

#### Сравнение объектов, загруженных при разных версиях модели данных

Сравнение можно провести с помощью выборки объектов через `GraphQL`.
Перейдите на соответствующую вкладку и отправьте GraphQL-запрос:

```graphql
{
 Person{
  name
  id
  sex
  birthday
  lastActivityDate
 }
}
```

Ответ будет выглядеть примерно так:

```graphql
{
 "data": {
   "Person": [
     {
      "id": 1,
      "sex": null,
      "birthday": null,
      "name": "Jonh Smith",
      "lastActivityDate": "2020-01-11"
     },
     {
      "id": 2,
      "sex": null,
      "birthday": null,
      "name": "Adam Sanders",
      "lastActivityDate": "2020-01-12"
     },
     {
      "id": 3,
      "sex": "male",
      "birthday": "1998-05-09",
      "name": "Isaac Blac",
      "lastActivityDate": "2020-01-13"
     }
    ]
  }
}
```
Обратите внимание, что новые поля у старых объектов выводятся со значением
по умолчанию - `null`.
